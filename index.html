<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Verde — Bootstrap 5.3</title>
    <!-- Bootstrap 5.3 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons (opcional) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Marca */
        --brand-green: #0b7d62; /* Verde principal */
        --brand-green-200: #6ed3a2; /* Verde claro */

        /* Ajuste del tema Bootstrap con los colores de marca */
        --bs-primary: var(--brand-green);
        --bs-success: var(--brand-green-200);
        --bs-primary-rgb: 11, 125, 98;
        --bs-success-rgb: 110, 211, 162;

        --card-grad-start: color-mix(
          in srgb,
          var(--brand-green) 12%,
          transparent
        );
        --card-grad-end: color-mix(
          in srgb,
          var(--brand-green-200) 18%,
          transparent
        );
      }

      body {
        background: #f6f9f7;
      }
      [data-bs-theme="dark"] body,
      [data-bs-theme="dark"] {
        background: #0f1412;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: linear-gradient(180deg, #0e8b71 0%, #0b7d62 100%);
        color: #e8fff5;
      }
      .sidebar a {
        color: #e8fff5;
      }
      .sidebar .nav-link.active,
      .sidebar .nav-link:hover {
        background: color-mix(in srgb, white 8%, transparent);
        color: #fff;
        border-radius: 0.5rem;
      }

      /* Main wrapper (desktop) */
      @media (min-width: 992px) {
        .main {
          margin-left: 260px;
        }
      }

      /* KPI cards */
      .kpi-card {
        background: radial-gradient(
              1200px 250px at 120% -10%,
              var(--card-grad-start),
              transparent
            )
            no-repeat,
          radial-gradient(
              900px 250px at -20% 120%,
              var(--card-grad-end),
              transparent
            )
            no-repeat,
          #ffffff;
        border: 1px solid rgba(11, 125, 98, 0.08);
      }

      /* Simple sparkline */
      .sparkline {
        width: 100%;
        height: 44px;
      }

      /* Area chart */
      .chart-wrap {
        position: relative;
      }
      .chart-svg {
        width: 100%;
        height: 260px;
        display: block;
      }

      .status-dot {
        width: 0.5rem;
        height: 0.5rem;
        display: inline-block;
        border-radius: 50%;
      }
      .dot-success {
        background: var(--brand-green-200);
      }
      .dot-warning {
        background: #ffd166;
      }
      .dot-danger {
        background: #ef476f;
      }

      .table thead th {
        background: rgba(11, 125, 98, 0.06);
      }

      .shadow-soft {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      }
    </style>
  </head>
  <body>
    <!-- Topbar -->
    <nav
      class="navbar navbar-expand-lg bg-white border-bottom sticky-top shadow-sm"
    >
      <div class="container-fluid">
        <button
          class="btn btn-outline-primary d-lg-none me-2"
          data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasSidebar"
          aria-controls="offcanvasSidebar"
        >
          <i class="bi bi-list"></i>
        </button>
        <a class="navbar-brand fw-bold text-primary" href="#">
          <i class="bi bi-speedometer2 me-1"></i> Dashboard Verde
        </a>
        <form
          class="d-none d-md-flex ms-auto me-3"
          role="search"
          style="max-width: 420px; width: 100%"
        >
          <input
            class="form-control"
            type="search"
            placeholder="Buscar…"
            aria-label="Buscar"
          />
        </form>
        <div class="d-flex align-items-center gap-2">
          <button
            id="themeToggle"
            class="btn btn-outline-secondary"
            type="button"
            title="Tema claro/oscuro"
          >
            <i class="bi bi-moon-stars"></i>
          </button>
          <div class="dropdown">
            <button
              class="btn btn-outline-primary dropdown-toggle"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <i class="bi bi-person-circle me-1"></i> Admin
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">Perfil</a></li>
              <li><a class="dropdown-item" href="#">Configuración</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="#">Salir</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- Sidebar (offcanvas mobile + fixed desktop) -->
    <div
      class="offcanvas offcanvas-start sidebar text-white d-lg-block"
      tabindex="-1"
      id="offcanvasSidebar"
      aria-labelledby="offcanvasSidebarLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasSidebarLabel">Menú</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body p-3">
        <nav class="nav nav-pills flex-column gap-1">
          <a
            class="nav-link d-flex align-items-center gap-2 active"
            aria-current="page"
            href="#"
          >
            <i class="bi bi-grid-1x2"></i> Resumen
          </a>
          <a class="nav-link d-flex align-items-center gap-2" href="#">
            <i class="bi bi-graph-up"></i> Analítica
          </a>
          <a class="nav-link d-flex align-items-center gap-2" href="#">
            <i class="bi bi-people"></i> Usuarios
          </a>
          <a class="nav-link d-flex align-items-center gap-2" href="#">
            <i class="bi bi-bag"></i> Ventas
          </a>
          <a class="nav-link d-flex align-items-center gap-2" href="#">
            <i class="bi bi-gear"></i> Ajustes
          </a>
        </nav>
        <hr class="border-light opacity-50" />
        <div class="small opacity-75">
          <i class="bi bi-info-circle me-1"></i> v1.0 — UI Bootstrap 5.3 (Verde)
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="main">
      <div class="container-fluid py-4">
        <!-- KPIs -->
        <div class="row g-3" id="kpiRow">
          <!-- Cards renderizadas por JS -->
          <div
            class="col-12 d-flex align-items-center justify-content-center py-5"
            id="kpiLoading"
          >
            <div
              class="spinner-border text-primary me-2"
              role="status"
              aria-hidden="true"
            ></div>
            <span>Cargando indicadores…</span>
          </div>
        </div>

        <!-- Chart + Activity -->
        <div class="row g-3 mt-1">
          <div class="col-12 col-xl-8">
            <div class="card shadow-soft">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <div>
                  <h5 class="card-title mb-0">Tendencia (30 días)</h5>
                  <small class="text-body-secondary"
                    >Datos actualizados vía AJAX</small
                  >
                </div>
                <div>
                  <span class="badge text-bg-success">En línea</span>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-wrap">
                  <svg
                    class="chart-svg"
                    viewBox="0 0 800 260"
                    preserveAspectRatio="none"
                    id="mainChart"
                    role="img"
                    aria-label="Gráfica de área"
                  ></svg>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-4">
            <div class="card h-100 shadow-soft">
              <div class="card-header">
                <h5 class="card-title mb-0">Actividad</h5>
              </div>
              <div class="card-body">
                <ul class="list-group list-group-flush" id="activityList">
                  <li class="list-group-item d-flex align-items-center gap-2">
                    <span class="status-dot dot-success"></span>
                    Cargando actividad…
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="card mt-3 shadow-soft">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5 class="card-title mb-0">Últimas transacciones</h5>
            <div class="input-group" style="max-width: 320px">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input
                type="search"
                class="form-control"
                placeholder="Buscar en la tabla"
                id="tableSearch"
              />
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle mb-0" id="trxTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Usuario</th>
                  <th>Monto</th>
                  <th>Estado</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="5" class="text-center py-5">
                    <div
                      class="spinner-border text-primary me-2"
                      role="status"
                      aria-hidden="true"
                    ></div>
                    Cargando…
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ====== THEME ======
      (function initTheme() {
        const root = document.documentElement;
        const stored = localStorage.getItem("theme");
        if (stored) root.setAttribute("data-bs-theme", stored);
        document.getElementById("themeToggle").addEventListener("click", () => {
          const now =
            root.getAttribute("data-bs-theme") === "dark" ? "light" : "dark";
          root.setAttribute("data-bs-theme", now);
          localStorage.setItem("theme", now);
        });
      })();

      // ====== FAKE API (AJAX-like) ======
      function apiGet(url) {
        // Puedes cambiar la URL y devolver distintos payloads
        return new Promise((resolve) => {
          setTimeout(() => {
            const today = new Date();
            const days = 30;
            // Generar serie de 30 días
            const series = Array.from({ length: days }, (_, i) => {
              const d = new Date(today);
              d.setDate(d.getDate() - (days - 1 - i));
              const base = 80 + Math.sin(i / 3) * 15 + (Math.random() * 10 - 5);
              return { t: +d, v: Math.max(0, Math.round(base)) };
            });

            // 4 KPI con miniseries
            function makeMiniSeries(mult) {
              return series.map((p) =>
                Math.round(p.v * mult + (Math.random() * 6 - 3))
              );
            }

            resolve({
              kpis: [
                {
                  label: "Usuarios activos",
                  value: 12450,
                  delta: 4.2,
                  series: makeMiniSeries(1.0),
                },
                {
                  label: "Ingresos (MXN)",
                  value: 57234,
                  delta: 2.8,
                  series: makeMiniSeries(0.9),
                },
                {
                  label: "Conversión (%)",
                  value: 3.2,
                  delta: -0.4,
                  series: makeMiniSeries(0.05),
                },
                {
                  label: "Uptime (%)",
                  value: 99.97,
                  delta: 0.01,
                  series: makeMiniSeries(1.2),
                },
              ],
              chart: series,
              activity: [
                "Nuevo registro: ana.garcia",
                "Pago confirmado: #A-2041",
                "Exportación CSV generada",
                "Rol actualizado para: ops-bot",
                "WebHook procesado: /orders/notify",
              ],
              transactions: Array.from({ length: 12 }, (_, i) => {
                const status = ["Completada", "Pendiente", "Fallida"];
                const st = status[Math.floor(Math.random() * status.length)];
                const amt = (Math.random() * 2500 + 200).toFixed(2);
                const d = new Date();
                d.setDate(d.getDate() - i);
                return {
                  id: 2000 + i,
                  user: [
                    "Juan Pérez",
                    "Ana García",
                    "María López",
                    "Carlos Ruiz",
                    "Lucía Torres",
                  ][i % 5],
                  amount: amt,
                  status: st,
                  date: d.toLocaleDateString("es-MX", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                  }),
                };
              }),
            });
          }, 900); // Simula latencia
        });
      }

      // ====== RENDER ======
      function formatNumber(n) {
        return new Intl.NumberFormat("es-MX").format(n);
      }

      function renderKpis(kpis) {
        const row = document.getElementById("kpiRow");
        document.getElementById("kpiLoading")?.remove();
        kpis.forEach((kpi, idx) => {
          const col = document.createElement("div");
          col.className = "col-12 col-sm-6 col-xxl-3";
          col.innerHTML = `
          <div class="card kpi-card shadow-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="text-body-secondary small">${kpi.label}</div>
                <span class="badge ${
                  kpi.delta >= 0 ? "text-bg-success" : "text-bg-danger"
                }">
                  ${
                    kpi.delta >= 0
                      ? '<i class="bi bi-arrow-up-right"></i>'
                      : '<i class="bi bi-arrow-down-right"></i>'
                  } ${Math.abs(kpi.delta)}%
                </span>
              </div>
              <div class="d-flex align-items-end justify-content-between">
                <div>
                  <div class="fs-2 fw-bold">${
                    kpi.label.includes("Conversión")
                      ? kpi.value.toFixed(2)
                      : formatNumber(kpi.value)
                  }${kpi.label.includes("%") ? "" : ""}</div>
                </div>
                <svg class="sparkline" viewBox="0 0 100 44" preserveAspectRatio="none" aria-hidden="true"></svg>
              </div>
            </div>
          </div>`;
          row.appendChild(col);
          const svg = col.querySelector("svg");
          drawSparkline(svg, kpi.series);
        });
      }

      function drawSparkline(svg, values) {
        if (!svg) return;
        const W = 100,
          H = 44,
          P = 4;
        const min = Math.min(...values),
          max = Math.max(...values);
        const range = max - min || 1;
        const step = (W - P * 2) / (values.length - 1);
        const pts = values.map((v, i) => {
          const x = P + step * i;
          const y = H - P - ((v - min) / range) * (H - P * 2);
          return [x, y];
        });
        const d = pts
          .map(
            (p, i) => (i ? "L" : "M") + p[0].toFixed(2) + " " + p[1].toFixed(2)
          )
          .join(" ");
        svg.innerHTML = `
        <defs>
          <linearGradient id="grad${Math.random()
            .toString(36)
            .slice(2)}" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="rgba(11,125,98,.5)"/>
            <stop offset="100%" stop-color="rgba(11,125,98,0)"/>
          </linearGradient>
        </defs>
        <path d="${d}" fill="none" stroke="var(--brand-green)" stroke-width="1.6" />`;
      }

      function renderAreaChart(svg, series) {
        if (!svg) return;
        const W = 800,
          H = 260,
          P = 24;
        svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
        const min = Math.min(...series.map((p) => p.v));
        const max = Math.max(...series.map((p) => p.v));
        const range = max - min || 1;
        const step = (W - P * 2) / (series.length - 1);
        const pts = series.map((p, i) => {
          const x = P + step * i;
          const y = H - P - ((p.v - min) / range) * (H - P * 2);
          return [x, y];
        });
        const line = pts
          .map(
            (p, i) => (i ? "L" : "M") + p[0].toFixed(2) + " " + p[1].toFixed(2)
          )
          .join(" ");
        const area = `${line} L ${P + step * (series.length - 1)} ${
          H - P
        } L ${P} ${H - P} Z`;

        const first = new Date(series[0].t).toLocaleDateString("es-MX");
        const last = new Date(series.at(-1).t).toLocaleDateString("es-MX");

        svg.innerHTML = `
        <defs>
          <linearGradient id="areagrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="rgba(110,211,162,.65)"/>
            <stop offset="100%" stop-color="rgba(110,211,162,0)"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="${W}" height="${H}" fill="none" />
        <g>
          <path d="${area}" fill="url(#areagrad)" />
          <path d="${line}" fill="none" stroke="var(--brand-green)" stroke-width="2.5" />
        </g>
        <g fill="currentColor" class="text-body-secondary" font-size="12">
          <text x="${P}" y="${H - 6}">${first}</text>
          <text x="${W - P - 4}" y="${H - 6}" text-anchor="end">${last}</text>
        </g>`;
      }

      function renderActivity(list) {
        const ul = document.getElementById("activityList");
        ul.innerHTML = "";
        list.forEach((txt, i) => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex align-items-center gap-2";
          const dotClass =
            i % 3 === 0
              ? "dot-success"
              : i % 3 === 1
              ? "dot-warning"
              : "dot-danger";
          li.innerHTML = `<span class="status-dot ${dotClass}"></span> ${txt}`;
          ul.appendChild(li);
        });
      }

      function renderTable(trxs) {
        const tbody = document.querySelector("#trxTable tbody");
        tbody.innerHTML = "";
        trxs.forEach((t) => {
          const tr = document.createElement("tr");
          const badge =
            t.status === "Completada"
              ? "success"
              : t.status === "Pendiente"
              ? "warning"
              : "danger";
          tr.innerHTML = `
          <td>${t.id}</td>
          <td>${t.user}</td>
          <td>$ ${formatNumber(t.amount)}</td>
          <td><span class="badge text-bg-${badge}">${t.status}</span></td>
          <td>${t.date}</td>`;
          tbody.appendChild(tr);
        });
      }

      // ====== SEARCH IN TABLE ======
      document
        .getElementById("tableSearch")
        .addEventListener("input", function () {
          const q = this.value.toLowerCase();
          document.querySelectorAll("#trxTable tbody tr").forEach((tr) => {
            tr.style.display = tr.textContent.toLowerCase().includes(q)
              ? ""
              : "none";
          });
        });

      // ====== INIT ======
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const data = await apiGet("/api/dashboard"); // AJAX fake
          renderKpis(data.kpis);
          renderAreaChart(document.getElementById("mainChart"), data.chart);
          renderActivity(data.activity);
          renderTable(data.transactions);
        } catch (err) {
          console.error(err);
        }
      });
    </script>
  </body>
</html>
